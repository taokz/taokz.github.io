<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Image Quality Selection</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
      text-align: center;
    }
    .images {
      display: flex;
      justify-content: center;
      gap: 60px;
      margin-top: 30px;
    }
    .image-box {
      text-align: center;
    }
    .image-box img {
      max-width: 250px;
      height: auto;
      border: 1px solid #ccc;
    }
    .unsure-option {
      margin: 20px 0;
    }
    .progress {
      margin-bottom: 20px;
      color: #666;
    }
    .reset-button {
      margin-top: 20px;
      padding: 10px;
      background-color: #ff4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      padding: 20px;
      box-sizing: border-box;
    }
    .modal img {
      max-width: 90%;
      max-height: 90vh;
      margin: auto;
      display: block;
      position: relative;
      top: 50%;
      transform: translateY(-50%);
    }
    .modal-close {
      position: absolute;
      right: 25px;
      top: 15px;
      color: #f1f1f1;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
    }
    .image-box img {
      cursor: pointer;
      transition: transform 0.2s;
    }
    .image-box img:hover {
      transform: scale(1.05);
    }
    .button-container {
        margin: 20px 0;
        display: flex;
        justify-content: center;
        gap: 20px;
    }

    .download-button {
        padding: 10px 20px;
        background-color: #4CAF50;  /* Green color */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .download-button:hover {
        background-color: #45a049;
    }

    .reset-button {
        padding: 10px 20px;
        background-color: #ff4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .reset-button:hover {
        background-color: #ff0000;
    }

    /* Add icon styles */
    .button-icon {
        font-size: 20px;
    }

    .nav-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }

    .nav-button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .nav-button:hover {
        background-color: #0056b3;
    }

    .nav-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    .home-button {
        background-color: #6c757d;
    }

    .home-button:hover {
        background-color: #5a6268;
    }
  </style>
</head>
<body>
  <h1>Website Title</h1>
  <div class="progress">Pair <span id="currentPair">1</span> of <span id="totalPairs">3</span></div>
  <h2>Task a: Select one image that is more clear / high quality</h2>

  <form id="qualityForm">
    <div class="images">
      <div class="image-box">
        <img id="img1" src="" alt="Image 1">
        <div>
          <label>
            <input type="radio" name="quality" value="image1" required>
            a. Image 1
          </label>
        </div>
      </div>
      <div class="image-box">
        <img id="img2" src="" alt="Image 2">
        <div>
          <label>
            <input type="radio" name="quality" value="image2">
            b. Image 2
          </label>
        </div>
      </div>
    </div>

    <div class="unsure-option">
      <label>
        <input type="radio" name="quality" value="unsure">
        c. Unsure
      </label>
    </div>

    <div class="nav-buttons">
        <button type="button" id="prevButton" class="nav-button" onclick="goToPrevious()">
            <span class="button-icon">‚¨ÖÔ∏è</span> Previous
        </button>
        <button type="submit" class="nav-button">
            Next <span class="button-icon">‚û°Ô∏è</span>
        </button>
        <button type="button" class="nav-button home-button" onclick="window.location.href='index.html'">
            <span class="button-icon">üè†</span> Return to Index
        </button>
    </div>
  </form>

  <!-- This is the download and reset buttons container -->
  <div class="button-container">
    <button type="button" class="download-button" onclick="downloadResponses()" style="display: flex !important;">
        <span class="button-icon">‚¨áÔ∏è</span> Download Responses
    </button>
    <button type="button" class="reset-button" onclick="resetAllChoices()">
        <span class="button-icon">üîÑ</span> Reset All Choices
    </button>
  </div>

  <!-- Modal div comes after -->
  <div id="imageModal" class="modal">
    <span class="modal-close">&times;</span>
    <img id="modalImage" src="" alt="Enlarged image">
  </div>

  <script>
    // Add this before allPairs definition
    async function loadPairsFromCSV() {
        try {
            const response = await fetch('./images/human_eval_paired_samples_by_cui_string_60_with_captions.csv');
            const csvText = await response.text();
            const lines = csvText.split('\n');
            const pairs = {};
            
            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                // Parse CSV line properly handling commas in captions
                const row = parseCSVLine(lines[i]);
                if (row.length < 7) continue; // Skip invalid lines
                
                const [id1, id2, cluster1, cluster2, cuis, caption1, caption2] = row;
                
                // In quality.html
                pairs[i] = {
                    image1: `./images/human_eval_paired_samples_by_cui_string_60/cluster_${cluster1}_${id1}.jpg`,
                    image2: `./images/human_eval_paired_samples_by_cui_string_60/cluster_${cluster2}_${id2}.jpg`
                };
                
                // In alignment.html, use this version instead:
                /*
                pairs[i] = {
                    image1: {
                        src: `./images/human_eval_paired_samples_by_cui_string_60/cluster_${cluster1}_${id1}.jpg`,
                        caption: caption1
                    },
                    image2: {
                        src: `./images/human_eval_paired_samples_by_cui_string_60/cluster_${cluster2}_${id2}.jpg`,
                        caption: caption2
                    }
                };
                */
            }
            return pairs;
        } catch (error) {
            console.error('Error loading CSV:', error);
            // Fallback to default pairs if CSV loading fails
            return {
                1: {
                    image1: './images/human_eval_paired_samples_by_cui_string_60/cluster_0_ROCOv2_2023_train_057368.jpg',
                    image2: './images/human_eval_paired_samples_by_cui_string_60/cluster_1_ROCOv2_2023_train_036981.jpg'
                }
            };
        }
    }

    // Add this helper function to properly parse CSV lines
    function parseCSVLine(line) {
        const result = [];
        let startValueIndex = 0;
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            if (line[i] === '"') {
                inQuotes = !inQuotes;
            } else if (line[i] === ',' && !inQuotes) {
                result.push(line.substring(startValueIndex, i).trim().replace(/^"|"$/g, ''));
                startValueIndex = i + 1;
            }
        }
        
        // Add the last value
        result.push(line.substring(startValueIndex).trim().replace(/^"|"$/g, ''));
        
        return result;
    }

    // Modify the initialization
    let allPairs = {};

    // Initialize the page with CSV data
    async function initializePage() {
        allPairs = await loadPairsFromCSV();
        const currentPair = parseInt(new URLSearchParams(window.location.search).get('pair')) || 1;
        
        document.getElementById('currentPair').textContent = currentPair;
        document.getElementById('totalPairs').textContent = Object.keys(allPairs).length;

        const pairData = allPairs[currentPair];
        if (pairData) {
            const img1 = document.getElementById('img1');
            const img2 = document.getElementById('img2');
            
            img1.src = pairData.image1;
            img2.src = pairData.image2;

            // Add click handlers for enlargement
            img1.onclick = function() { showImage(pairData.image1); }
            img2.onclick = function() { showImage(pairData.image2); }
        }
    }

    // Generate or retrieve session ID
    let sessionId = localStorage.getItem('evaluationSessionId');
    if (!sessionId) {
      sessionId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('evaluationSessionId', sessionId);
    }

    // Save response to localStorage
    function saveResponse(key, value) {
      const responses = JSON.parse(localStorage.getItem('responses') || '{}');
      responses[key] = value;
      localStorage.setItem('responses', JSON.stringify(responses));
      return true;
    }

    // Load responses from localStorage
    function loadResponses() {
      return JSON.parse(localStorage.getItem('responses') || '{}');
    }

    // Find the first incomplete pair
    async function findFirstIncompletePair() {
      const responses = loadResponses();
      
      for (let i = 1; i <= Object.keys(allPairs).length; i++) {
        if (!responses[`pair_${i}_quality`]) {
          return i;
        }
        if (!responses[`pair_${i}_alignment`]) {
          window.location.href = `alignment.html?pair=${i}`;
          return;
        }
      }
      return Object.keys(allPairs).length;
    }

    // Add these new functions
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const closeBtn = document.querySelector('.modal-close');

    // Function to open modal
    function showImage(imgSrc) {
      modal.style.display = "block";
      modalImg.src = imgSrc;
    }

    // Close modal when clicking the √ó button
    closeBtn.onclick = function() {
      modal.style.display = "none";
    }

    // Close modal when clicking outside the image
    modal.onclick = function(e) {
      if (e.target === modal) {
        modal.style.display = "none";
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.style.display === "block") {
        modal.style.display = "none";
      }
    });

    // Reset all choices
    function resetAllChoices() {
      if (confirm('Are you sure you want to reset all your choices? This cannot be undone.')) {
        localStorage.removeItem('responses');
        localStorage.removeItem('evaluationSessionId');
        window.location.href = 'quality.html?pair=1';
      }
    }

    // Handle form submission
    document.getElementById('qualityForm').addEventListener('submit', function(evt) {
      evt.preventDefault();
      const currentPair = parseInt(new URLSearchParams(window.location.search).get('pair')) || 1;
      const choice = document.querySelector('input[name=quality]:checked').value;

      try {
        // Save the choice immediately to localStorage
        const success = saveResponse(`pair_${currentPair}_quality`, choice);
        
        if (success) {
          window.location.href = `alignment.html?pair=${currentPair}`;
        } else {
          alert('Error saving your choice. Please try again.');
        }
      } catch (error) {
        console.error('Error saving choice:', error);
        alert('Error saving your choice. Please try again.');
      }
    });

    // Initialize when document is ready
    document.addEventListener('DOMContentLoaded', initializePage);

    // Add this function to your existing JavaScript
    function downloadResponses() {
      const responses = loadResponses();
      
      // Check if there are any responses
      if (Object.keys(responses).length === 0) {
          alert('No responses to download yet. Please complete at least one evaluation.');
          return;
      }

      // Add timestamp and metadata to the download
      const downloadData = {
          timestamp: new Date().toISOString(),
          totalPairs: Object.keys(allPairs).length,
          responses: responses
      };

      const dataStr = JSON.stringify(downloadData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      
      // Add timestamp to filename
      const date = new Date().toISOString().split('T')[0];
      link.download = `image_evaluation_responses_${date}.json`;
      
      // Show feedback
      const downloadButton = document.querySelector('.download-button');
      const originalText = downloadButton.innerHTML;
      downloadButton.innerHTML = '<span class="button-icon">‚úÖ</span> Downloaded!';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      // Reset button text after 2 seconds
      setTimeout(() => {
          downloadButton.innerHTML = originalText;
      }, 2000);
    }

    // Add this after your other functions
    function goToPrevious() {
        const currentPair = parseInt(new URLSearchParams(window.location.search).get('pair')) || 1;
        
        if (currentPair > 1) {
            // If we're on quality.html, go to alignment of previous pair
            window.location.href = `alignment.html?pair=${currentPair - 1}`;
        } else {
            // If we're at first pair, go to index
            window.location.href = 'index.html';
        }
    }
  </script>
</body>
</html>